<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MINI-Бот MAX</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    #app { max-width: 400px; margin: auto; background: #fff; padding: 20px; border-radius: 8px;
           box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .btn { display: block; width: 100%; padding: 12px; margin: 8px 0;
           border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    #btn-about     { background: #0073e6; color: #fff; }
    #btn-faculties { background: #28a745; color: #fff; }
    #btn-admission { background: #ffc107; color: #333; }
    #btn-contacts  { background: #dc3545; color: #fff; }
    #response { margin-top: 20px; color: #555; min-height: 1.2em; }
  </style>
</head>
<body>
  <div id="app">
    <h2>Чат-бот MAX</h2>
    <button id="btn-about"     class="btn">Об университете</button>
    <button id="btn-faculties" class="btn">Факультеты</button>
    <button id="btn-admission" class="btn">Поступление</button>
    <button id="btn-contacts"  class="btn">Контакты</button>
    <div id="response">Нажмите кнопку для отправки</div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const respEl = document.getElementById('response');

    // 1. Извлекаем hash без решетки
    const rawHash = window.location.hash.substring(1);

    // 2. Парсим параметры первого уровня
    const hashParams = new URLSearchParams(rawHash);
    const webAppDataEncoded = hashParams.get('WebAppData') || '';

    // 3. Декодируем и парсим параметры WebAppData
    const webAppData = decodeURIComponent(webAppDataEncoded);
    const wadParams = new URLSearchParams(webAppData);

    // 4. Извлекаем JSON-поле "chat"
    const chatJsonEncoded = wadParams.get('chat') || '';
    const chatJson = decodeURIComponent(chatJsonEncoded);
    let chatId;
    try {
      chatId = JSON.parse(chatJson).id;
    } catch {
      respEl.textContent = 'Ошибка: не удалось распарсить chat_id';
      return;
    }

    // 5. Готовим API-запрос
    const API_URL = 'https://platform-api.max.ru/messages';
    const TOKEN   = 'Bearer f9LHodD0cOLJjXHISi1iYXayzdY7GauJeKP4WUgqkGTr5hzOXffTFF75iX04WB0CzrS5LRRU5WX8hsMXyvM1';

    const headers = new Headers();
    headers.append('Content-Type', 'application/json');
    headers.append('Authorization', TOKEN);

    // 6. Функция отправки
    async function sendToChat(text) {
      respEl.textContent = 'Отправляем запрос...';
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          mode: 'cors',
          headers: headers,
          body: JSON.stringify({ chat_id: chatId, text })
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`${res.status}: ${errText}`);
        }
        respEl.textContent = 'Запрос отправлен. Ответ придёт в чате.';
      } catch (err) {
        respEl.textContent = 'Ошибка: ' + err.message;
      }
    }

    // 7. Привязываем кнопки
    document.getElementById('btn-about')
      .addEventListener('click', () => sendToChat('Расскажите об университете'));
    document.getElementById('btn-faculties')
      .addEventListener('click', () => sendToChat('Какие есть факультеты'));
    document.getElementById('btn-admission')
      .addEventListener('click', () => sendToChat('Условия поступления'));
    document.getElementById('btn-contacts')
      .addEventListener('click', () => sendToChat('Контактная информация университета'));
  });
  </script>
</body>
</html>
